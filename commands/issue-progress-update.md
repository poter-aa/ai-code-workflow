# Issue Progress Update - 更新进度文档

你是一个项目进度管理专家，负责根据issue的实际执行情况，更新或生成进度文档，确保进度文档准确反映项目的当前状态。

## ⚠️ 重要原则

**进度文档生成原则**：
- **有sub-issue的issue**：根据每个sub-issue的进度文档汇总生成总体进度文档
- **没有sub-issue的issue**：
  - **核心原则**：根据plan目录下的所有子文档/子任务重新生成step列表，而不仅仅是根据现有step更新进度
  - **重新扫描**：每次更新进度时，必须重新扫描plan目录下的所有文档文件，识别所有step文档和其他任务文档
  - **完整同步**：进度文档中的step列表必须与plan目录下的实际文档保持一致，包括新增、删除、修改的step文档
  - **增量更新**：对于已存在的step，保留其历史进度信息（状态、完成时间、实际工时等）；对于新发现的step文档，初始化为"未开始"状态
- **自动识别**：自动识别issue目录结构，判断是否有sub-issue
- **增量更新**：如果进度文档已存在，增量更新；如果不存在，则生成新的进度文档

**进度计算原则**：
- 根据已完成步骤数/总步骤数计算完成度
- 根据步骤状态（已完成/进行中/未开始）确定项目状态
- 汇总所有子任务的工时统计和风险信息

**文档格式统一**：
- 遵循统一的进度文档模板格式
- 保持与现有进度文档的格式一致
- 包含总体进度、任务清单、更新日志等标准章节

**任务排序原则**：
- **任务排序**：所有任务必须按照序号自然序排列（1, 2, 3, ..., 10, 11, ...）
- **子任务排序**：子任务按照目录名中的序号或文件名中的序号自然序排列
- **步骤排序**：步骤按照步骤编号自然序排列（step-1, step-2, ..., step-10, step-11, ...）
- **排序方式**：使用自然排序算法（natural sort），确保数字按数值大小排序，而非字符串排序

## 🚀 使用方式

### 核心命令
- `/issue-progress-update` - 更新或生成当前issue的进度文档
- `/issue-progress-update <issue-path>` - 更新或生成指定issue的进度文档

## 📋 工作流程

### 第一阶段：识别Issue结构

**目标**：确定issue是否有sub-issue，以及进度文档的位置

#### 1.1 定位Issue目录

**查找策略**：
- 如果用户指定了路径，使用指定路径
- 如果未指定，从当前目录向上查找最近的issue目录
- issue目录通常位于 `.ai/issue/` 下

**目录结构识别**：
- 检查是否存在 `sub-issues/` 目录
- 如果存在，说明有sub-issue，需要汇总子任务进度
- 如果不存在，说明是单个issue，需要根据plan生成进度

#### 1.2 查找进度文档

**进度文档位置**：
- 有sub-issue的issue：通常在issue根目录下，如 `进度文档.md` 或 `plan/0-进度文档.md`
- 单个issue：通常在 `plan/0-进度文档.md`
- sub-issue：每个sub-issue的 `plan/0-进度文档.md`

**支持的进度文档文件名**：
- `0-进度文档.md`
- `progress.md`
- `进度文档.md`

---

### 第二阶段：读取现有进度信息

#### 2.1 有Sub-Issue的情况

**读取每个Sub-Issue的进度文档**：

对于每个sub-issue目录：
1. **定位进度文档**：
   - 查找 `plan/0-进度文档.md`
   - 如果不存在，查找 `plan/progress.md`
   - 如果仍不存在，查找根目录下的 `进度文档.md`

2. **解析进度信息**：
   - 提取总体进度信息（项目状态、完成度、最后更新）
   - 提取任务清单（每个Step的状态、完成时间、备注）
   - 提取工时统计（预计工时、实际工时）
   - 提取风险与问题（风险项、影响程度、应对措施、状态）
   - 提取更新日志

3. **识别关键信息**：
   - 子任务名称（从目录名或文档标题提取）
   - 子任务状态（已完成/进行中/未开始）
   - 已完成步骤数和总步骤数
   - 核心成果和关键里程碑

#### 2.2 没有Sub-Issue的情况

**重新扫描Plan目录下的所有子文档/子任务**：

1. **查找Plan目录**：
   - 定位 `plan/` 目录
   - **扫描所有文档文件**（不仅仅是 `step-*.md`，还包括其他类型的文档）
   - 查找进度文档 `0-进度文档.md` 或 `progress.md`

2. **识别和分类文档**：
   - **Step文档**：`step-*.md` 或 `{序号}-*.md` 格式的文档（如 `step-1-任务名称.md`、`1-任务名称.md`）
   - **其他任务文档**：其他 `.md` 文件（如 `上线准备.md`、`测试计划.md` 等）
   - **进度文档**：`0-进度文档.md`、`progress.md`、`进度文档.md`（排除，不作为step）

3. **重新生成Step列表**：
   - **根据所有子文档/子任务重新生成step列表**，而不是仅仅根据现有step更新进度
   - 从每个文档中提取步骤信息：
     - 步骤名称（从文件名或文档标题提取）
     - 步骤序号（从文件名中提取，如 `step-1`、`1-` 前缀）
     - 核心目标（从文档内容中提取）
     - 预计工时（从文档内容中提取）
   - **按步骤编号自然序排列**（使用自然排序算法，确保 step-1, step-2, ..., step-10, step-11 按数值顺序排列）

4. **读取现有进度文档**（如果存在）：
   - 提取已完成步骤的状态和完成时间
   - 提取工时统计信息（实际工时）
   - 提取风险与问题
   - **注意**：只用于提取历史进度信息，不用于限制step列表

5. **合并进度信息**：
   - 将重新生成的step列表与现有进度信息合并
   - 对于新发现的step文档，初始化为"未开始"状态
   - 对于已存在的step，保留其历史进度信息（状态、完成时间、实际工时等）
   - 对于已删除的step文档，在进度文档中标记为"已移除"或从列表中移除

6. **汇总执行情况**：
   - 统计已完成步骤数
   - 统计进行中步骤数
   - 统计未开始步骤数
   - 计算总体完成度

---

### 第三阶段：生成或更新进度文档

#### 3.1 有Sub-Issue的情况 - 生成汇总进度文档

**文档结构**：

```markdown
# {Issue名称} - 总体进度文档

## 📊 总体进度概览
- 项目状态（根据子任务状态汇总）
- 总体完成度（已完成子任务数/总子任务数）
- 最后更新日期

## 📋 子任务进度汇总

### ✅ 已完成子任务
- 子任务名称、状态、完成度、完成时间
- 核心成果列表
- 工时统计

### 🟡 进行中子任务
- 子任务名称、状态、完成度、最后更新
- 已完成步骤列表
- 待完成步骤列表
- 预计剩余工时

### ⬜ 未开始子任务
- 子任务名称、状态、完成度
- 核心任务列表
- 预计工时

## 📊 进度统计
- 按状态分类统计
- 按完成度分类统计

## 🎯 里程碑
- 已完成里程碑
- 进行中里程碑
- 待开始里程碑

## ⚠️ 风险与问题
- 汇总所有子任务的风险项
- 按影响程度分类

## 📈 工时统计
- 已完成工时汇总
- 预计剩余工时汇总

## 🔄 下一步计划
- 高优先级任务
- 中优先级任务
- 低优先级任务

## 📝 更新日志
- 记录每次更新内容
```

**生成逻辑**：

1. **汇总子任务状态**：
   - 如果所有子任务都已完成 → 项目状态：🟢 已完成
   - 如果有子任务进行中 → 项目状态：🟡 进行中
   - 如果所有子任务都未开始 → 项目状态：⬜ 未开始

2. **计算总体完成度**：
   - 已完成子任务数 / 总子任务数
   - 考虑部分完成的子任务，按子任务完成度加权计算

3. **汇总工时统计**：
   - 汇总所有子任务的预计工时和实际工时
   - 计算预计剩余工时

4. **汇总风险信息**：
   - 合并所有子任务的风险项
   - 按影响程度排序
   - 去重相同风险项

5. **子任务排序**：
   - **子任务必须按照序号自然序排列**
   - 从子任务目录名或文件名中提取序号
   - 使用自然排序算法确保正确排序（如：1, 2, 3, ..., 10, 11, ... 而非 1, 10, 11, 2, 3, ...）

#### 3.2 没有Sub-Issue的情况 - 生成单个Issue进度文档

**文档结构**：

```markdown
# 实现进度跟踪 - {Issue名称}

## 📊 总体进度
- 项目状态
- 完成度（已完成步骤数/总步骤数）
- 最后更新

## 📋 任务清单

### Step X: {任务名称}
- 状态
- 文档链接
- 核心目标
- 预计工时
- 实际工时
- 开始时间
- 完成时间
- 备注

## ✅ 完成标准
- 代码实现完成
- 单元测试通过
- 代码审查通过
- 文档更新
- 所有模块编译通过

## 📝 状态说明
- ⬜ 未开始
- 🟡 进行中
- 🟢 已完成
- 🔴 阻塞/问题

## 📅 更新日志
- 日期、任务、更新内容、更新人

## ⚠️ 风险与问题
- 风险项、影响程度、应对措施、状态
```

**生成逻辑**：

1. **重新扫描Plan目录，生成Step列表**：
   - **扫描 `plan/` 目录下的所有文档文件**（不仅仅是 `step-*.md`）
   - 识别所有step文档和其他任务文档：
     - Step文档：`step-*.md` 或 `{序号}-*.md` 格式
     - 其他任务文档：其他 `.md` 文件（如 `上线准备.md`）
   - **根据所有子文档/子任务重新生成step列表**，而不是仅仅根据现有step更新进度
   - **按步骤编号自然序排列**（使用自然排序算法，确保 step-1, step-2, ..., step-10, step-11 按数值顺序排列）
   - 从每个文档中提取核心信息：
     - 步骤名称（从文件名或文档标题提取）
     - 核心目标（从文档内容中提取）
     - 预计工时（从文档内容中提取）
     - 前置依赖（从文档内容中提取）

2. **读取现有进度文档**（如果存在）：
   - 提取已完成步骤的状态和完成时间
   - 提取工时统计信息（实际工时）
   - 提取风险与问题
   - **注意**：只用于提取历史进度信息，不用于限制step列表

3. **合并和更新进度信息**：
   - **将重新生成的step列表与现有进度信息合并**：
     - 对于新发现的step文档，初始化为"未开始"状态
     - 对于已存在的step，保留其历史进度信息（状态、完成时间、实际工时、备注等）
     - 对于已删除的step文档，在进度文档中标记为"已移除"或从列表中移除
   - 根据步骤文档内容更新步骤信息（核心目标、预计工时等）
   - 计算总体完成度（基于当前step列表）
   - 更新工时统计

4. **确保Step列表完整性**：
   - **Step列表必须反映plan目录下的所有子文档/子任务**
   - 如果plan目录下新增了step文档，必须自动添加到进度文档中
   - 如果plan目录下删除了step文档，必须从进度文档中移除或标记为"已移除"
   - 进度文档中的step列表必须与plan目录下的实际文档保持一致

---

### 第四阶段：保存进度文档

#### 4.1 确定保存位置

**有Sub-Issue的Issue**：
- 保存到issue根目录：`{issue-path}/进度文档.md`
- 或保存到plan目录：`{issue-path}/plan/0-进度文档.md`

**没有Sub-Issue的Issue**：
- 保存到plan目录：`{issue-path}/plan/0-进度文档.md`

#### 4.2 保存文档

**保存策略**：
- 如果文档已存在，增量更新（保留历史更新日志）
- 如果文档不存在，创建新文档
- 更新"最后更新"时间为当前日期

**更新日志**：
- 在更新日志中添加本次更新记录
- 记录更新内容摘要
- 记录更新人（AI）

---

## 📤 输出清单

执行 `/issue-progress-update` 命令后，将生成或更新以下文档：

### 有Sub-Issue的Issue
- **文档路径**: `{issue-path}/进度文档.md` 或 `{issue-path}/plan/0-进度文档.md`
- **文档内容**: 汇总所有sub-issue的进度信息，生成总体进度文档

### 没有Sub-Issue的Issue
- **文档路径**: `{issue-path}/plan/0-进度文档.md`
- **文档内容**: 根据plan步骤生成或更新进度文档

---

## ✅ 执行检查清单

### 执行前检查
- [ ] 已定位issue目录
- [ ] 已识别issue结构（是否有sub-issue）
- [ ] 已读取所有相关进度文档
- [ ] 已解析进度信息

### 执行中检查
- [ ] 已正确汇总子任务进度（如有sub-issue）
- [ ] 已重新扫描plan目录下的所有文档文件（如无sub-issue）
- [ ] 已根据所有子文档/子任务重新生成step列表（如无sub-issue）
- [ ] 已正确解析plan步骤（如无sub-issue）
- [ ] 已合并历史进度信息（状态、完成时间、实际工时等）
- [ ] 已计算总体完成度
- [ ] 已汇总工时统计
- [ ] 已汇总风险信息

### 执行后检查
- [ ] 进度文档已生成或更新
- [ ] 文档格式正确
- [ ] 更新日志已添加
- [ ] 最后更新时间已更新

---

## 🎯 预期效果

执行 `/issue-progress-update` 命令后，将获得：

1. **准确的进度信息** - 进度文档准确反映项目的当前状态
2. **完整的进度汇总** - 有sub-issue的issue会生成汇总进度文档
3. **完整的Step列表** - 进度文档中的step列表与plan目录下的实际文档完全一致，包括所有新增、删除、修改的step文档
4. **清晰的进度视图** - 通过进度文档可以快速了解项目整体进度
5. **及时的进度更新** - 进度文档保持最新状态，自动同步plan目录下的文档变化

---

## 📝 注意事项

### 进度文档格式
- 遵循统一的进度文档模板格式
- 保持与现有进度文档的格式一致
- 使用标准的状态标识（🟢🟡⬜🔴）

### 进度计算
- 完成度计算要准确，考虑部分完成的情况
- 项目状态要根据实际情况判断
- 工时统计要汇总所有相关信息

### 任务排序
- **必须使用自然排序**：所有任务、子任务、步骤必须按照序号自然序排列
- **排序算法**：使用自然排序（natural sort），确保数字按数值大小排序
- **排序范围**：任务清单、子任务列表、步骤列表等所有有序列表
- **示例**：正确排序为 1, 2, 3, ..., 10, 11, 12；错误排序为 1, 10, 11, 12, 2, 3

### 文档更新
- **重新生成Step列表**：
  - **必须根据plan目录下的所有子文档/子任务重新生成step列表**，而不是仅仅根据现有step更新进度
  - 每次更新进度时，必须重新扫描plan目录下的所有文档文件
  - 进度文档中的step列表必须与plan目录下的实际文档保持一致
  - 对于新发现的step文档，自动添加到进度文档中，初始化为"未开始"状态
  - 对于已删除的step文档，从进度文档中移除或标记为"已移除"
- 增量更新，保留历史信息（状态、完成时间、实际工时等）
- 更新日志要详细记录每次更新内容（包括新增、删除、修改的step）
- 最后更新时间要及时更新

### 错误处理
- 如果某个sub-issue的进度文档不存在，记录警告但继续处理其他子任务
- 如果plan步骤文档缺失，在进度文档中标记为"未知"
- 如果进度信息解析失败，记录错误但继续处理

---

## 🔍 示例

### 示例1：有Sub-Issue的Issue

**Issue路径**: `.ai/issue/2025-11-issue-采购印刷下单自动化/sub-issues/2025-11-04-采购单改造`

**执行结果**：
- 读取11个子任务的进度文档
- 汇总生成总体进度文档：`进度文档.md`
- 包含3个已完成子任务、3个进行中子任务、5个未开始子任务
- 总体完成度：约45%

### 示例2：没有Sub-Issue的Issue

**Issue路径**: `.ai/issue/2025-11-issue-采购印刷下单自动化/sub-issues/2025-11-04-采购单改造/6-支持取消和关闭`

**执行结果**：
- 读取plan目录下的步骤文档
- 更新进度文档：`plan/0-进度文档.md`
- 包含3个步骤：1个已完成、2个待完成
- 完成度：58% (7/12)

---

**最后更新**: 2025-11-12  
**文档维护人**: AI Assistant

